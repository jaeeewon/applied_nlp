import os
from g2p_en import G2p
from tqdm import tqdm
from datasets import Dataset, DatasetDict, Features, Value, Sequence

librispeech_subsets = [
    "dev-clean",
    "dev-other",
    "test-clean",
    "test-other",
    "train-clean-100",
    "train-clean-360",
    "train-other-500",
]


def get_librispeech_phonemes(root_dir: str, subset: str):
    g2p = G2p()
    for i in tqdm(os.listdir(f"{root_dir}/{subset}")):
        if not i.isdigit():
            continue
        for ii in os.listdir(f"{root_dir}/{subset}/{i}"):
            if not ii.isdigit():
                continue
            path = f"{root_dir}/{subset}/{i}/{ii}"
            with open(f"{path}/{i}-{ii}.trans.txt", encoding="utf-8") as f:
                for line in f:
                    id, text = line.strip().split(" ", maxsplit=1)
                    phonemes = g2p(text)
                    yield {"id": id, "text": text, "phonemes": phonemes}


def push_datasets(root_dir: str, repo_id: str, config_name: str, hf_token: str):
    splits = {}

    features = Features(
        {
            "id": Value("string"),
            "text": Value("string"),
            "phonemes": Sequence(Value("string")),
        }
    )

    for subset in librispeech_subsets:
        split = subset.replace("-", ".")
        splits[split] = Dataset.from_generator(
            get_librispeech_phonemes,
            gen_kwargs={"root_dir": root_dir, "subset": subset},
            features=features,
            split=split,
        )

    ds = DatasetDict(splits)

    ds.push_to_hub(
        repo_id=repo_id, config_name=config_name, private=False, token=hf_token
    )


if __name__ == "__main__":
    root_dir = "/home/jpong/Workspace/jaeeewon/LibriSpeech"
    repo_id = "jaeeewon/librispeech_phonemes"
    config_name = "origin"

    print(f"===== get_librispeech_phonemes [dev-clean] =====")
    transcriptions = get_librispeech_phonemes(
        root_dir=root_dir,
        subset="dev-clean",
    )
    print(transcriptions.__next__())
    print()

    print(f"===== push_datasets =====")
    hf_token = os.getenv("HF_API_TOKEN")
    assert hf_token, "HF_API_TOKEN is required to push datasets"

    push_datasets(
        root_dir=root_dir, repo_id=repo_id, config_name=config_name, hf_token=hf_token
    )
    print("successfully uploaded")
    print(f"visit: https://huggingface.co/datasets/{repo_id}")

"""
===== get_librispeech_phonemes [dev-clean] =====
  0%|                                                                                                                                                                                                                                                     | 0/41 [00:00<?, ?it/s]
{'id': '1673-143397-0000', 'text': 'ARDENT IN THE PROSECUTION OF HERESY CYRIL AUSPICIOUSLY OPENED HIS REIGN BY OPPRESSING THE NOVATIANS THE MOST INNOCENT AND HARMLESS OF THE SECTARIES', 'phonemes': ['AA1', 'R', 'D', 'AH0', 'N', 'T', ' ', 'IH0', 'N', ' ', 'DH', 'AH0', ' ', 'P', 'R', 'AA2', 'S', 'AH0', 'K', 'Y', 'UW1', 'SH', 'AH0', 'N', ' ', 'AH1', 'V', ' ', 'HH', 'EH1', 'R', 'AH0', 'S', 'IY0', ' ', 'S', 'IH1', 'R', 'AH0', 'L', ' ', 'AO2', 'S', 'P', 'IY1', 'S', 'IH0', 'K', 'AH0', 'L', 'IY0', 'Z', ' ', 'OW1', 'P', 'AH0', 'N', 'D', ' ', 'HH', 'IH1', 'Z', ' ', 'R', 'EY1', 'N', ' ', 'B', 'AY1', ' ', 'AH0', 'P', 'R', 'EH1', 'S', 'IH0', 'NG', ' ', 'DH', 'AH0', ' ', 'N', 'OW0', 'V', 'EY1', 'SH', 'AH0', 'N', 'Z', ' ', 'DH', 'AH0', ' ', 'M', 'OW1', 'S', 'T', ' ', 'IH1', 'N', 'AH0', 'S', 'AH0', 'N', 'T', ' ', 'AH0', 'N', 'D', ' ', 'HH', 'AA1', 'R', 'M', 'L', 'AH0', 'S', ' ', 'AH1', 'V', ' ', 'DH', 'AH0', ' ', 'S', 'EH1', 'K', 'T', 'ER0', 'IY0', 'Z']}                                                                                                                                            
===== push_datasets =====
100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1167/1167 [02:59<00:00,  6.49it/s]
Generating train.other.500 split: 148688 examples [03:00, 824.18 examples/s] 
Creating parquet from Arrow format: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00, 109.55ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  430kB /  430kB,  196kB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  430kB /  430kB,  196kB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  430kB /  430kB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:03<00:00,  3.17s/ shards]
Creating parquet from Arrow format: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00, 113.05ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  402kB /  402kB,  402kB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  402kB /  402kB,  402kB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  402kB /  402kB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:01<00:00,  1.91s/ shards]
Creating parquet from Arrow format: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00, 109.03ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  420kB /  420kB,  420kB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  420kB /  420kB,  420kB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  420kB /  420kB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:01<00:00,  1.94s/ shards]
Creating parquet from Arrow format: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00, 108.08ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  410kB /  410kB,  410kB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  410kB /  410kB,  410kB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████|  410kB /  410kB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:02<00:00,  2.03s/ shards]
Creating parquet from Arrow format: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00,  6.10ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7.29MB / 7.29MB, 3.31MB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7.29MB / 7.29MB, 3.31MB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7.29MB / 7.29MB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:03<00:00,  3.29s/ shards]
Creating parquet from Arrow format: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2/2 [00:00<00:00,  2.28ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 26.4MB / 26.4MB, 7.32MB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 26.4MB / 26.4MB, 7.32MB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 26.4MB / 26.4MB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05<00:00,  5.80s/ shards]
Creating parquet from Arrow format: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2/2 [00:01<00:00,  1.56ba/s]
Processing Files (1 / 1)      : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 35.2MB / 35.2MB, 7.99MB/s  
New Data Upload               : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 35.1MB / 35.1MB, 7.98MB/s  
                              : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 35.2MB / 35.2MB            
Uploading the dataset shards: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:07<00:00,  7.22s/ shards]
README.md: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 30.0/30.0 [00:00<00:00, 248kB/s]
successfully uploaded                                                                                                                                                                                                                                 | 0.00/30.0 [00:00<?, ?B/s]
visit: https://huggingface.co/datasets/jaeeewon/librispeech_phonemes
  0%|                                                                                                                                                                                                                                                     | 0/41 [03:29<?, ?it/s]

"""